<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanSys - Iniciar Sesión</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="login-container">
        <div class="login-card">
            <h1 style="color: #6200EE;">PanSys</h1>
            <p>Sistema de Gestión Panadero</p>
            <br>

            <!-- Formulario de Login -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" placeholder="admin@pansys.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" placeholder="********" required>
                </div>
                <div id="error-message"
                    style="color: #B00020; margin-bottom: 10px; font-size: 14px; display: none; padding: 10px; background-color: #FFEBEE; border-radius: 5px; border-left: 4px solid #B00020;">
                </div>
                <button type="submit" id="loginBtn">Ingresar</button>
            </form>

            <div style="margin-top: 20px; text-align: center;">
                <p style="color: #666; font-size: 14px;">
                    ¿No tienes cuenta?
                    <a href="#" id="showRegisterBtn"
                        style="color: #6200EE; font-weight: bold; text-decoration: none;">Regístrate aquí</a>
                </p>
            </div>

            <p style="margin-top:20px; font-size:12px; color:#888;">
                Versión 2.0 - Conectado a API REST
            </p>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="modal-registro" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-btn" id="closeRegisterModal">&times;</span>
            <h2 style="color: var(--primary-color); margin-bottom: 10px;">Crear Nueva Cuenta</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Completa los datos para registrarte en PanSys
            </p>

            <form id="registerForm">
                <div class="form-group">
                    <label for="reg-nombre">Nombre Completo *</label>
                    <input type="text" id="reg-nombre" placeholder="Juan Pérez" required>
                </div>

                <div class="form-group">
                    <label for="reg-email">Correo Electrónico *</label>
                    <input type="email" id="reg-email" placeholder="juan@ejemplo.com" required>
                </div>

                <div class="form-group">
                    <label for="reg-password">Contraseña *</label>
                    <input type="password" id="reg-password" placeholder="Mínimo 6 caracteres" required minlength="6">
                    <small style="color: #666; font-size: 12px;">Mínimo 6 caracteres</small>
                </div>

                <div class="form-group">
                    <label for="reg-password-confirm">Confirmar Contraseña *</label>
                    <input type="password" id="reg-password-confirm" placeholder="Repite tu contraseña" required
                        minlength="6">
                </div>

                <div class="form-group">
                    <label for="reg-rol">Rol</label>
                    <select id="reg-rol" class="input-select">
                        <option value="usuario">Usuario</option>
                        <option value="admin">Administrador</option>
                        <option value="panadero">Panadero</option>
                    </select>
                </div>

                <div id="register-error-message"
                    style="color: #B00020; margin-bottom: 10px; font-size: 14px; display: none; padding: 10px; background-color: #FFEBEE; border-radius: 5px; border-left: 4px solid #B00020;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-cancelar" id="cancelRegisterBtn"
                        style="width: auto; flex: 1;">Cancelar</button>
                    <button type="submit" class="btn-primary" id="registerBtn"
                        style="width: auto; flex: 1;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <script src="api-service.js"></script>
    <script>
        // Verificar si ya está autenticado
        if (api.isAuthenticated()) {
            window.location.href = 'dashboard.html';
        }

        // ============================================
        // LOGIN
        // ============================================

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('error-message');

            // Validaciones básicas
            if (!email || !password) {
                errorMessage.textContent = '⚠️ Por favor completa todos los campos';
                errorMessage.style.display = 'block';
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMessage.textContent = '⚠️ Por favor ingresa un correo electrónico válido';
                errorMessage.style.display = 'block';
                return;
            }

            // Ocultar mensaje de error previo
            errorMessage.style.display = 'none';

            // Mostrar loading
            const hideLoading = showLoading(loginBtn);

            try {
                const response = await api.login(email, password);

                // Login exitoso
                showSuccess('✓ ¡Bienvenido! Redirigiendo al dashboard...');

                // Esperar un momento antes de redirigir
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                // Mostrar error específico
                let errorMsg = '❌ Error al iniciar sesión';

                if (error.message.includes('Credenciales inválidas') ||
                    error.message.includes('inválidas') ||
                    error.message.includes('401')) {
                    errorMsg = '❌ Correo o contraseña incorrectos. Por favor verifica tus credenciales.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMsg = '❌ No se puede conectar al servidor. Verifica que el backend esté corriendo.';
                } else if (error.message) {
                    errorMsg = '❌ ' + error.message;
                }

                errorMessage.textContent = errorMsg;
                errorMessage.style.display = 'block';
                hideLoading();

                // Limpiar contraseña por seguridad
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        });

        // ============================================
        // REGISTRO
        // ============================================

        // Mostrar modal de registro
        document.getElementById('showRegisterBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('modal-registro').style.display = 'block';
            document.getElementById('reg-nombre').focus();
        });

        // Cerrar modal de registro
        document.getElementById('closeRegisterModal').addEventListener('click', () => {
            document.getElementById('modal-registro').style.display = 'none';
            document.getElementById('registerForm').reset();
            document.getElementById('register-error-message').style.display = 'none';
        });

        document.getElementById('cancelRegisterBtn').addEventListener('click', () => {
            document.getElementById('modal-registro').style.display = 'none';
            document.getElementById('registerForm').reset();
            document.getElementById('register-error-message').style.display = 'none';
        });

        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('modal-registro');
            if (e.target === modal) {
                modal.style.display = 'none';
                document.getElementById('registerForm').reset();
                document.getElementById('register-error-message').style.display = 'none';
            }
        });

        // Manejar formulario de registro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre = document.getElementById('reg-nombre').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const passwordConfirm = document.getElementById('reg-password-confirm').value;
            const rol = document.getElementById('reg-rol').value;
            const registerBtn = document.getElementById('registerBtn');
            const errorMessage = document.getElementById('register-error-message');

            // Validaciones
            if (!nombre || !email || !password || !passwordConfirm) {
                errorMessage.textContent = '⚠️ Por favor completa todos los campos obligatorios';
                errorMessage.style.display = 'block';
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMessage.textContent = '⚠️ Por favor ingresa un correo electrónico válido';
                errorMessage.style.display = 'block';
                return;
            }

            // Validar longitud de contraseña
            if (password.length < 6) {
                errorMessage.textContent = '⚠️ La contraseña debe tener al menos 6 caracteres';
                errorMessage.style.display = 'block';
                return;
            }

            // Validar que las contraseñas coincidan
            if (password !== passwordConfirm) {
                errorMessage.textContent = '⚠️ Las contraseñas no coinciden';
                errorMessage.style.display = 'block';
                return;
            }

            // Ocultar mensaje de error previo
            errorMessage.style.display = 'none';

            // Mostrar loading
            const hideLoading = showLoading(registerBtn);

            try {
                // Registrar usuario
                const response = await api.request('/auth/register', {
                    method: 'POST',
                    auth: false,
                    body: JSON.stringify({
                        nombre: nombre,
                        email: email,
                        password: password,
                        rol: rol
                    })
                });

                // Registro exitoso
                showSuccess('✓ ¡Cuenta creada exitosamente! Ahora puedes iniciar sesión.');

                // Cerrar modal
                document.getElementById('modal-registro').style.display = 'none';
                document.getElementById('registerForm').reset();

                // Pre-llenar el email en el login
                document.getElementById('email').value = email;
                document.getElementById('password').focus();

                hideLoading();

            } catch (error) {
                // Mostrar error específico
                let errorMsg = '❌ Error al crear la cuenta';

                if (error.message.includes('correo ya está en uso') ||
                    error.message.includes('409') ||
                    error.message.includes('duplicate')) {
                    errorMsg = '❌ Este correo electrónico ya está registrado. Intenta iniciar sesión.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMsg = '❌ No se puede conectar al servidor. Verifica que el backend esté corriendo.';
                } else if (error.message) {
                    errorMsg = '❌ ' + error.message;
                }

                errorMessage.textContent = errorMsg;
                errorMessage.style.display = 'block';
                hideLoading();
            }
        });

        // Validación en tiempo real de contraseñas
        document.getElementById('reg-password-confirm').addEventListener('input', (e) => {
            const password = document.getElementById('reg-password').value;
            const passwordConfirm = e.target.value;
            const errorMessage = document.getElementById('register-error-message');

            if (passwordConfirm && password !== passwordConfirm) {
                errorMessage.textContent = '⚠️ Las contraseñas no coinciden';
                errorMessage.style.display = 'block';
            } else {
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>

</html>